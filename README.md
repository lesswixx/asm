# asm

* Новиков Егор Сергеевич, P33101
* `asm | cisc | neum | hw | instr | struct | stream | mem | pstr | prob1 | [4]char`
* Без усложнения

## Язык программирования

Форма Бэкуса-Наура:

```text
<program> ::= [ <data_section> ] <text_section>

<data_section> ::= "section .data" <constants>
<constants> ::= <constant> | <constant> <constants>
<constant> ::= <label> ":" <const_val>
<const_val> ::= <string>

<text_section> ::= "section .text" <code_lines>
<code_lines> ::= <code_line> | <code_line> <code_lines>
<code_line> ::= <label> ":" | <local_label> ":" | <instruction>
<instruction> ::= <opcode> [ <arguments> ]
<arguments> ::= <argument> | <argument> "," <arguments>
<argument> ::= <label> | <local_label> | <memory_address> | <register> | <number> | <register_number_operation>
<memory_address> ::= "*" <register> | "*" <number>
<register_number_operation> ::= <register> <operation> <number>

<opcode> ::= "mov" | "movnum2reg" | "movnum2mem" | "movreg2reg" | "movreg2mem" | "movmem2reg" 
  | "movmem2mem" | "movregnum2reg" | "inc" | "dec" | "add" | "addreg" | "sub" | "div" | "mod" 
  | "cmp" | "push" | "pop" | "je" | "jne" | "jmp" | "call" | "ret" | "halt"

<operation> ::= "+" | "-" | "/" | "%"
<register> ::= "a0" | "a1" | "a2" | "a3" | "r0" | "r1" | "r2" | "r3" | "sp"

<number> ::= [ "-" ] <unsigned_number>
<unsigned_number> ::= <digit> | <digit> <unsigned_number>
<digit> ::= "0" | "1" | "2" | "3" | "4" | "5" | "6" | "7" | "8" | "9"

<string> ::= '"' <string_letters> '"'
<string_letters> ::= "" | <string_letter> | <string_letter> <string_letters>
<string_letter> ::= <any symbol except: '"'>

<local_label> ::= "." <label>
<label> ::= <label_letters>
<label_letters> ::= <label_letter> | <label_letter> <label_letters>
<label_letter> ::= "A" | "B" | "C" | "D" | "E" | "F" | "G" | "H" | "I" 
  | "J" | "K" | "L" | "M" | "N" | "O" | "P" | "Q" | "R" | "S" | "T" | "U" 
  | "V" | "W" | "X" | "Y" | "Z" | "a" | "b" | "c" | "d" | "e" | "f" | "g" 
  | "h" | "i" | "j" | "k" | "l" | "m" | "n" | "o" | "p" | "q" | "r" | "s" 
  | "t" | "u" | "v" | "w" | "x" | "y" | "z" | "_"
```

Программа состоит из обязательной программной секции и необязательной секции данных.

Секция с данными представляет перечисление констант, которые состоят из названия и хранящихся данных.

Программная секция состоит из последовательных инструкций и меток для логической группировки инструкций.

Инструкции выполняются последовательно сверху вниз, начиная с метки `start:`. 

Любая инструкция состоит из названия и аргументов. Инструкции `call` и `ret` позволяют
работать с группой инструкций, как с функцией. Инструкции условного и безусловного перехода (`jmp`, `je`, `jne`)
позволяют изменить последовательной порядок исполнения и продолжить программу с другой точки (метки).

В качестве аргумента может быть число (`42`), регистр (`r1`), операция между регистром и числом (`r0 / 10`), 
название метки или константы (`label` или `.label`), адрес памяти (`*r2` или `*100`).

Список всех инструкций и их описание можно найти в разделе "Система команд".

Метки и константы доступны из любой точки программы. Локальные метки (начинаются с точки) доступны только изнутри
функции (разные функции могут иметь одинаковые локальные метки).


## Организация памяти

Программисту доступны следующие регистры:
* `a0`, `a1`, `a2`, `a3` - регистры, обычно использующиеся для передачи аргументов
* `r0`, `r1`, `r2`, `r3` - регистры, не имеющие специального назначения
* `sp` - указатель стека, обычно использующийся для выделения памяти на стеке или передачи дополнительных аргументов

Память общая для данных и для инструкций.

Имеет примерно следующий вид:

```text
    +------------------------+
    |         Memory         |
    +------------------------+
    | 0:   jmp s             |
    | 1:   <func1 code>      |
    | ...                    |
    | f:   <func2 code>      |
    | ...                    |
    | s:   <start code>      |
    | ...                    |
    | m:   halt              |
    | m+1: empty word        |
    | m+2: <const1>          |
    | ...                    |
    | m+c: <constC>          |
    | ...                    |
    | ...                    |
    | n:   stack start       |
    +------------------------+
```

Машинное слово - 32 бита.

Первая инструкция - переход к основной программе (начинается с метки `start:`). Далее располагаются инструкции 
в том же порядке, в каком они были написаны программистом.

Примечание: приведен пример расположения в памяти "типичной программы". Ничего не мешает программисту расположить
основную программу в начале файла. В таком случае инструкции `jmp` не будет, память начнется сразу же с инструкций
основной программы.

За последней инструкцией исходного кода программы располагается пустое машинное слово (сделано с целью 
избежания исполнения данных, как кода).

Далее хранятся константы в том порядке, в котором они были объявлены в секции с данными.

В конце памяти находится стек, который по мере исполнения программы "растет" вверх.

Для хранения динамических данных программист может воспользоваться выделением памяти на стеке (регистр `sp`).


## Система команд

Все регистры имеют разрядность 32 бита за исключением регистра `fl`, имеющего разрядность 4 бита.

Полный список регистров:

| Название | Доступен программисту | Описание                                                |
|----------|-----------------------|---------------------------------------------------------|
| `a0`     | да                    | регистр для передачи первого аргумента функции          |
| `a1`     | да                    | регистр для передачи второго аргумента функции          |
| `a2`     | да                    | регистр для передачи третьего аргумента функции         |
| `a3`     | да                    | регистр для передачи четвертого аргумента функции       |
| `r0`     | да                    | не имеет специального назначения                        |
| `r1`     | да                    | не имеет специального назначения                        |
| `r2`     | да                    | не имеет специального назначения                        |
| `r3`     | да                    | не имеет специального назначения                        |
| `sp`     | да                    | указатель на вершину стека                              |
| `ip`     | нет                   | указатель на исполняемую инструкции                     |
| `ir`     | нет                   | содержит исполняемую инструкцию                         |
| `ar`     | нет                   | регистр адреса, используется для операций чтения/записи |
| `dr`     | нет                   | регистр данных, используется для операций чтения/записи |
| `fl`     | нет                   | содержит флаги по результатам операции (NZVC)           |

Доступ к памяти осуществляет при помощи регистров `ar` и `dr`. Для чтения необходимо задать адрес ячейки. 
Для записи необходимо задать адрес и данные.

Ввод/вывод отображается на память. Для вывода необходимо выполнить запись в ячейку памяти по определенному адресу. 
Для ввода необходимо выполнить чтение определенной (другой) ячейки памяти.

Имеется адресация памяти 2 типов:
* абсолютная (`*100`)
* абсолютная от регистра (`*r2`)

Инструкции... пизда


## Транслятор


## Модель процессора


## Тестирование